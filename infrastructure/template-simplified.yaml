AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  SharpCRM Infrastructure (Simplified)
  
  Serverless backend with Lambda functions and API Gateway
  Database tables will be created manually using npm run init-db:global

# Global configuration for all resources
Globals:
  Function:
    Timeout: 30
    Runtime: nodejs18.x
    MemorySize: 512
    Environment:
      Variables:
        NODE_ENV: !Ref Environment
        REGION: !Ref AWS::Region
        # Table names will be generated by init-db:global script
        TABLE_PREFIX: !Ref TablePrefix
        JWT_SECRET: !Ref JWTSecret
        JWT_REFRESH_SECRET: !Ref JWTRefreshSecret
        SUPER_ADMIN_EMAIL: "rootuser@sharp.com"
        SUPER_ADMIN_PASSWORD: "User@123"
        SUPER_ADMIN_FIRST_NAME: "Root"
        SUPER_ADMIN_LAST_NAME: "User"
        SUPER_ADMIN_ROLE: "SUPER_ADMIN"
        SUPER_ADMIN_TENANT_ID: "SUPER_ADMIN_TENANT"
        SUPER_ADMIN_CREATED_BY: "SYSTEM"
        FRONTEND_URL: "https://d9xj0evv3ouwa.cloudfront.net"
        FRONTEND_URL_ALT_1: "http://localhost:5174"
        FRONTEND_URL_ALT_2: "http://localhost:5175"
  Api:
    Cors:
      AllowMethods:
        - DELETE
        - GET
        - HEAD
        - OPTIONS
        - PATCH
        - POST
        - PUT
      AllowHeaders:
        - Content-Type
        - X-Amz-Date
        - Authorization
        - X-Api-Key
        - X-Amz-Security-Token
      AllowOrigin:
        - https://d9xj0evv3ouwa.cloudfront.net
      AllowCredentials: true
      MaxAge: 600
    GatewayResponses:
      DEFAULT_4XX:
        ResponseParameters:
          Headers:
            Access-Control-Allow-Origin: "'https://d9xj0evv3ouwa.cloudfront.net'"
            Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
            Access-Control-Allow-Credentials: "'true'"
      DEFAULT_5XX:
        ResponseParameters:
          Headers:
            Access-Control-Allow-Origin: "'https://d9xj0evv3ouwa.cloudfront.net'"
            Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
            Access-Control-Allow-Credentials: "'true'"

# Parameters allow you to customize the deployment
Parameters:
  Environment:
    Type: String
    Default: development
    AllowedValues:
      - development
      - staging
      - production
    Description: Environment name
  
  TablePrefix:
    Type: String
    Default: SharpCRM
    Description: Prefix for table names
  
  JWTSecret:
    Type: String
    Default: "your-super-secret-jwt-key-change-this-in-production"
    Description: JWT Secret for token signing
    NoEcho: true
  
  JWTRefreshSecret:
    Type: String
    Default: "your-super-secret-jwt-refresh-key-change-this-in-production"
    Description: JWT Refresh Secret for refresh token signing
    NoEcho: true

# Resources define the AWS infrastructure
Resources:
  # Main Backend Lambda Function
  BackendFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${TablePrefix}-Backend-${Environment}"
      CodeUri: ../backend/
      Handler: dist/lambda.handler
      Runtime: nodejs18.x
      MemorySize: 512
      Timeout: 30
      Environment:
        Variables:
          NODE_ENV: !Ref Environment
          REGION: !Ref AWS::Region
          TABLE_PREFIX: !Ref TablePrefix
          JWT_SECRET: !Ref JWTSecret
          JWT_REFRESH_SECRET: !Ref JWTRefreshSecret
          SUPER_ADMIN_EMAIL: "rootuser@sharp.com"
          SUPER_ADMIN_PASSWORD: "User@123"
          SUPER_ADMIN_FIRST_NAME: "Root"
          SUPER_ADMIN_LAST_NAME: "User"
          SUPER_ADMIN_ROLE: "SUPER_ADMIN"
          SUPER_ADMIN_TENANT_ID: "SUPER_ADMIN_TENANT"
          SUPER_ADMIN_CREATED_BY: "SYSTEM"
          FRONTEND_URL: "https://d9xj0evv3ouwa.cloudfront.net"
          FRONTEND_URL_ALT_1: "http://localhost:5174"
          FRONTEND_URL_ALT_2: "http://localhost:5175"
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
            RestApiId: !Ref BackendApi
        HealthCheck:
          Type: Api
          Properties:
            Path: /health
            Method: GET
            RestApiId: !Ref BackendApi
      FunctionUrlConfig:
        AuthType: NONE
        Cors:
          AllowCredentials: true
          AllowMethods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
          AllowHeaders:
            - Content-Type
            - Authorization
            - X-Amz-Date
            - X-Api-Key
            - X-Amz-Security-Token
          AllowOrigins:
            - "https://d9xj0evv3ouwa.cloudfront.net"
            - "http://localhost:5173"
            - "http://localhost:5174"
            - "http://localhost:5175"
          MaxAge: 600
      Policies:
        # Broad DynamoDB permissions for table creation and management
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:CreateTable
                - dynamodb:DescribeTable
                - dynamodb:ListTables
                - dynamodb:DeleteTable
                - dynamodb:PutItem
                - dynamodb:GetItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
                - dynamodb:BatchGetItem
                - dynamodb:BatchWriteItem
              Resource: 
                - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TablePrefix}-*"
                - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TablePrefix}-*/index/*"
            - Effect: Allow
              Action:
                - dynamodb:ListTables
                - dynamodb:DescribeTable
              Resource: "*"
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: '*'

  # API Gateway
  BackendApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${TablePrefix}-API-${Environment}"
      StageName: !Ref Environment
      Cors:
        AllowMethods:
          - DELETE
          - GET
          - HEAD
          - PATCH
          - POST
          - PUT
        AllowHeaders:
          - Content-Type
          - X-Amz-Date
          - Authorization
          - X-Api-Key
          - X-Amz-Security-Token
        AllowOrigin:
          - https://d9xj0evv3ouwa.cloudfront.net
        AllowCredentials: true
        MaxAge: 600
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'https://d9xj0evv3ouwa.cloudfront.net'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              Access-Control-Allow-Credentials: "'true'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'https://d9xj0evv3ouwa.cloudfront.net'"
              Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              Access-Control-Allow-Credentials: "'true'"

  # Token Cleanup Lambda (scheduled) - Optional, can be removed if not needed
  TokenCleanupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${TablePrefix}-TokenCleanup-${Environment}"
      CodeUri: ../backend/
      Handler: dist/lambda.tokenCleanupHandler
      Runtime: nodejs18.x
      MemorySize: 256
      Timeout: 60
      Environment:
        Variables:
          NODE_ENV: !Ref Environment
          REGION: !Ref AWS::Region
          TABLE_PREFIX: !Ref TablePrefix
      Events:
        ScheduledCleanup:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
            Description: "Daily cleanup of expired refresh tokens"
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:DeleteItem
                - dynamodb:Scan
              Resource: 
                - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TablePrefix}-RefreshTokens-${Environment}"
                - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TablePrefix}-RefreshTokens-${Environment}/index/*"
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: '*'

# Outputs provide information about the created resources
Outputs:
  # API Gateway URL
  BackendApiUrl:
    Description: "API Gateway endpoint URL for the backend"
    Value: !Sub "https://${BackendApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/"
    Export:
      Name: !Sub "${AWS::StackName}-BackendApiUrl"
  
  BackendFunctionArn:
    Description: "ARN of the Backend Lambda function"
    Value: !GetAtt BackendFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-BackendFunctionArn"
  
  BackendFunctionUrl:
    Description: "Lambda Function URL for direct access (bypasses API Gateway)"
    Value: !GetAtt BackendFunctionUrl.FunctionUrl
    Export:
      Name: !Sub "${AWS::StackName}-BackendFunctionUrl"
  
  Environment:
    Description: "Deployment environment"
    Value: !Ref Environment
    Export:
      Name: !Sub "${AWS::StackName}-Environment"
  
  TablePrefix:
    Description: "Table prefix for DynamoDB tables"
    Value: !Ref TablePrefix
    Export:
      Name: !Sub "${AWS::StackName}-TablePrefix"
